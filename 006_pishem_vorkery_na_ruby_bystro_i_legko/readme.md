# Пишем воркеры на ruby быстро и легко

Имея некоторый опыт написания воркеров на ruby, искренне хочется им поделится с другими.

[giph01](http://gph.is/YBYKQX)

Начнем с того что такое воркер и для чего он нужен.

Иногда при создание какой либо информационной системы возникает потребность запустить какой либо код по расписанию или запустить тяжелый участок кода. При этом наше приложение должно быстро отвечать на запросы другим клиентам.

Примеры таких ситуаций:

* найти всех покупателей в большой базе данных которые что либо положили сегодня в корзину, но не оформили заказ и отправить им письмо напоминание
* сформировать отчет о состояние системы за весь текущий день
* посчитать статистику за сегодняшний день и сохранить ее в отдельную таблицу в базе
* запустить выгрузку информации из системы в xls/csv-файл
* импорт информации в систему из сторонней системы или из стороннего файла

С решением этих задач отлично справляются воркеры.

## WHENEVER

Для записей задач по расписанию существует гем [whenever](https://github.com/javan/whenever).

Работать с ним очень легко, после установки гема остается записать все отложенные задачи в файл с расписанием schedule.rb. Пример файла:

```ruby
every 3.hours do
  runner “Item.export_data"
end
every 1.day, :at => ‘09:30 am' do
  runner “User.send_email"
end
every 1.day :at => ’23:00 pm’ do
  runner “Statistic.save_daily_report"
end
```

## DELAYED JOB

Следующий полезный гем это [delayed_job](https://github.com/collectiveidea/delayed_job). Любую тяжелую для выполнения функцию можно делегировать на выполнение ему. Этот гем работает по следующему алгоритму:

* Любой тяжелый для выполнениям метод делегируем ему через метод delay.
* Рельса сохраняет код который нужно выполнить в отдельную таблицу в БД.
* Воркер анализируя текущую загруженность сервера, запускает поочередно необходимые задачи.
* При этом пишет логи о удачном или неудачном выполнении команд.

Но не забывайте что при его использовании, кроме запуска рельсы, на сервере нужно запустить отдельный процесс-воркер. Delayed_jobs очень полезный гем который я рекомендую.

## DELAYED JOBS RECURRING

На случай если нужно запускать тяжелые задачи по расписанию и при этом хочется использовать delayed_job, можно написать воркер при помощи гема [delayed_jobs_recurring](https://github.com/amitree/delayed_job_recurring).

Этот гем позволяет достаточно удобно написать воркер и настроить для него расписание. Пример воркера:

```ruby
# app/workers/my_worker.rb
class MyWorker
  include Delayed::RecurringJob

  run_every 7.day
  run_at '09:00am'

  def perform
    # Do work!
  end
end
```

Для инициализации воркера нужно лишь написать следующее.

```ruby
# config/initializers/workers.rb
MyWorker.schedule!
```

Вот так быстро и удобно можно писать и применять воркеры в своем приложении.

[Medium](https://kopilov-vlad.medium.com/%D0%BF%D0%B8%D1%88%D0%B5%D0%BC-%D0%B2%D0%BE%D1%80%D0%BA%D0%B5%D1%80%D1%8B-%D0%BD%D0%B0-ruby-%D0%B1%D1%8B%D1%81%D1%82%D1%80%D0%BE-%D0%B8-%D0%BB%D0%B5%D0%B3%D0%BA%D0%BE-3ff1cf9715a2)
